<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Module 3 | High Throughout Genomics Analysis 2021</title>
  <meta name="description" content="Workshop website for the 2021 High Throughput Genomics Analysis Canadian Bioinformatics Workshop" />
  <meta name="generator" content="bookdown 0.43 and GitBook 2.6.7" />

  <meta property="og:title" content="Module 3 | High Throughout Genomics Analysis 2021" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="https://github.com/cbw-dev/HTG-2021/blob/main/index.Rmd/img/bioinformatics_logo.png" />
  <meta property="og:description" content="Workshop website for the 2021 High Throughput Genomics Analysis Canadian Bioinformatics Workshop" />
  <meta name="github-repo" content="cbw-dev/HTG-2021" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Module 3 | High Throughout Genomics Analysis 2021" />
  
  <meta name="twitter:description" content="Workshop website for the 2021 High Throughput Genomics Analysis Canadian Bioinformatics Workshop" />
  <meta name="twitter:image" content="https://github.com/cbw-dev/HTG-2021/blob/main/index.Rmd/img/bioinformatics_logo.png" />

<meta name="author" content="Faculty: Mathieu Bourgey, Jared Simpson, Robert Syme, Daniel Poppleton, BF Francis Ouellette, Rachade Hmamouchi" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
<link rel="prev" href="module-2-data-visualization-with-igv.html"/>
<link rel="next" href="module-4-single-nucleotide-variant-calling.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">



<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<a href="https://bioinformaticsdotca.github.io/">
 <img src="img/bioinformatics_logo.png" width="90%" alt="bioinformatics.ca logo" style="display:block; margin-left:auto; margin-right:auto; margin-top:15px;">
 </a>
<li><center><strong><a href="./"><br>High Throughput Genomics Analysis<br><br></a></strong></center></li>
<a href="./">
 <img src="img/CBW-HTG-icon.png" width="70%" alt="High Throughput Genomics Analysis logo" style="display:block; margin-left:auto; margin-right:auto; ">
 </a>
<br>

<li class="divider"></li>
<li class="part"><span><b>I Introduction</b></span></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Workshop Info</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#schedule"><i class="fa fa-check"></i>Schedule</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#pre-work"><i class="fa fa-check"></i>Pre-work</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="meet-your-faculty.html"><a href="meet-your-faculty.html"><i class="fa fa-check"></i>Meet Your Faculty</a></li>
<li class="chapter" data-level="" data-path="data-and-compute-setup.html"><a href="data-and-compute-setup.html"><i class="fa fa-check"></i>Data and Compute Setup</a>
<ul>
<li class="chapter" data-level="" data-path="data-and-compute-setup.html"><a href="data-and-compute-setup.html#course-data-downloads"><i class="fa fa-check"></i>Course data downloads</a></li>
<li class="chapter" data-level="" data-path="data-and-compute-setup.html"><a href="data-and-compute-setup.html#compute-setup"><i class="fa fa-check"></i>Compute setup</a>
<ul>
<li class="chapter" data-level="" data-path="data-and-compute-setup.html"><a href="data-and-compute-setup.html#aws-and-unix-intro"><i class="fa fa-check"></i>AWS and Unix Intro</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>II Modules</b></span></li>
<li class="chapter" data-level="" data-path="module-1-introduction.html"><a href="module-1-introduction.html"><i class="fa fa-check"></i>Module 1: Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="module-1-introduction.html"><a href="module-1-introduction.html#lecture"><i class="fa fa-check"></i>Lecture</a>
<ul>
<li class="chapter" data-level="" data-path="module-1-introduction.html"><a href="module-1-introduction.html#introduction-to-sequencing-technologies"><i class="fa fa-check"></i>Introduction to Sequencing Technologies</a></li>
<li class="chapter" data-level="" data-path="module-1-introduction.html"><a href="module-1-introduction.html#introduction-to-hts-file-formats"><i class="fa fa-check"></i>Introduction to HTS File Formats</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="module-2-data-visualization-with-igv.html"><a href="module-2-data-visualization-with-igv.html"><i class="fa fa-check"></i>Module 2: Data Visualization with IGV</a>
<ul>
<li class="chapter" data-level="" data-path="module-2-data-visualization-with-igv.html"><a href="module-2-data-visualization-with-igv.html#lecture-1"><i class="fa fa-check"></i>Lecture</a></li>
<li class="chapter" data-level="" data-path="module-2-data-visualization-with-igv.html"><a href="module-2-data-visualization-with-igv.html#lab"><i class="fa fa-check"></i>Lab</a>
<ul>
<li class="chapter" data-level="" data-path="module-2-data-visualization-with-igv.html"><a href="module-2-data-visualization-with-igv.html#visualization-part-1-getting-familiar-with-igv"><i class="fa fa-check"></i>Visualization Part 1: Getting Familiar with IGV</a></li>
<li class="chapter" data-level="" data-path="module-2-data-visualization-with-igv.html"><a href="module-2-data-visualization-with-igv.html#visualization-part-2-inspecting-snps-snvs-and-svs"><i class="fa fa-check"></i>Visualization Part 2: Inspecting SNPs, SNVs, and SVs</a></li>
<li class="chapter" data-level="" data-path="module-2-data-visualization-with-igv.html"><a href="module-2-data-visualization-with-igv.html#visualization-part-3-automating-tasks-in-igv-optional"><i class="fa fa-check"></i>Visualization Part 3: Automating Tasks in IGV (Optional)</a></li>
<li class="chapter" data-level="" data-path="module-2-data-visualization-with-igv.html"><a href="module-2-data-visualization-with-igv.html#visualization-part-4-visualizing-long-reads"><i class="fa fa-check"></i>Visualization Part 4: Visualizing Long Reads</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="module-2-data-visualization-with-igv.html"><a href="module-2-data-visualization-with-igv.html#lab-answers"><i class="fa fa-check"></i>Lab Answers</a>
<ul>
<li class="chapter" data-level="" data-path="module-2-data-visualization-with-igv.html"><a href="module-2-data-visualization-with-igv.html#visualization-part-2-inspecting-snps-snvs-and-svs-1"><i class="fa fa-check"></i>Visualization Part 2: Inspecting SNPs, SNVs, and SVs</a></li>
<li class="chapter" data-level="" data-path="module-2-data-visualization-with-igv.html"><a href="module-2-data-visualization-with-igv.html#visualization-part-4-visualizing-long-reads-1"><i class="fa fa-check"></i>Visualization Part 4: Visualizing Long Reads</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html"><i class="fa fa-check"></i>Module 3</a>
<ul>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#lecture-2"><i class="fa fa-check"></i>Lecture</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#lab-1"><i class="fa fa-check"></i>Lab</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="module-4-single-nucleotide-variant-calling.html"><a href="module-4-single-nucleotide-variant-calling.html"><i class="fa fa-check"></i>Module 4: Single Nucleotide Variant Calling</a>
<ul>
<li class="chapter" data-level="" data-path="module-4-single-nucleotide-variant-calling.html"><a href="module-4-single-nucleotide-variant-calling.html#lecture-3"><i class="fa fa-check"></i>Lecture</a></li>
<li class="chapter" data-level="" data-path="module-4-single-nucleotide-variant-calling.html"><a href="module-4-single-nucleotide-variant-calling.html#lab-2"><i class="fa fa-check"></i>Lab</a></li>
</ul></li>
<li class="divider"></li>
<h1 id="sponsors">Sponsors</h1>

<div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; padding-bottom: 20px;">
  <a href="https://aws.amazon.com/fr/education/awseducate/">
    <img src="img/sponsors/AWS-educate-logo.png" style="height: 70px;" alt="AWS Educate logo.">
  </a>
  <a href="https://www.mcgill.ca/micm/">
    <img src="img/sponsors/MICM-logo.png" style="height: 70px;" alt="McGill Initiative in Computation Medicine logo.">
  </a>
  <a href="https://computationalgenomics.ca/">
    <img src="img/sponsors/c3g-logo.png" style="height: 70px;" alt="Canadian Centre for Computational Genomics.">
  </a>
  <a href="https://www.mcgill.ca/neuro/">
    <img src="img/sponsors/neuro-logo.png" style="height: 70px;" alt="The Neuro logo.">
  </a>
  <a href="https://oicr.on.ca/">
    <img src="img/sponsors/oicr.png" style="height: 70px;" alt="Ontario Institute for Cancer Research logo.">
  </a>
  <a href="https://www.hpcforhealth.ca/">
    <img src="img/sponsors/hpc4health.png" style="height: 70px;" alt="HPC4Health logo.">
  </a>
  <a href="https://www.impactt-microbiome.ca/">
    <img src="img/sponsors/IMPACTT-logo.png" style="height: 70px;" alt="IMPACTT logo.">
  </a>
</div>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">High Throughout Genomics Analysis 2021</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="module-3" class="section level1 hasAnchor">
<h1>Module 3<a href="module-3.html#module-3" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="lecture-2" class="section level2 hasAnchor">
<h2>Lecture<a href="module-3.html#lecture-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<iframe src="https://drive.google.com/file/d/15hy-fOn7rQHxPEPaXmhNZ-1_N-R_Sfm0/preview" width="640" height="480" allow="autoplay">
</iframe>
</div>
<div id="lab-1" class="section level2 hasAnchor">
<h2>Lab<a href="module-3.html#lab-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><em>Created by Mathieu Bourgey, Ph.D</em></p>
<div id="introduction-1" class="section level4 hasAnchor">
<h4>Introduction<a href="module-3.html#introduction-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This workshop will show you how to launch individual first steps of a DNA-Seq pipeline</p>
<p>We will be working on a 1000 genome sample, NA12878. You can find the whole raw data on the 1000 genome website: <a href="https://www.internationalgenome.org/data">http://www.1000genomes.org/data</a></p>
<p>NA12878 is the child of the trio while NA12891 and NA12892 are her parents.</p>
<table>
<thead>
<tr class="header">
<th>Mother</th>
<th>Father</th>
<th>Child</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>NA12892</td>
<td>NA12891</td>
<td>NA12878</td>
</tr>
</tbody>
</table>
<p>If you finish early, feel free to perform the same steps on the other two individuals: NA12891 &amp; NA12892.</p>
<p>For practical reasons we subsampled the reads from the sample because running the whole dataset would take way too much time and resources. We’re going to focus on the reads extracted from a 300 kbp stretch of chromosome 1.</p>
<table>
<thead>
<tr class="header">
<th>Chromosome</th>
<th>Start</th>
<th>End</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>17704860</td>
<td>18004860</td>
</tr>
</tbody>
</table>
</div>
<div id="original-setup" class="section level4 hasAnchor">
<h4>Original Setup<a href="module-3.html#original-setup" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div id="software-requirements" class="section level5 hasAnchor">
<h5>Software Requirements<a href="module-3.html#software-requirements" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>These are all already installed, but here are the original links.</p>
<ul>
<li>BVATools</li>
<li>SAMTools</li>
<li>BWA</li>
<li>Genome Analysis ToolKit</li>
<li>Trimmomatic</li>
</ul>
</div>
</div>
<div id="environment-setup" class="section level4 hasAnchor">
<h4>Environment setup<a href="module-3.html#environment-setup" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div id="launching-the-container" class="section level5 hasAnchor">
<h5>Launching the container<a href="module-3.html#launching-the-container" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<pre><code>mkdir -p $HOME/workspace/HTG/Module3/

docker run --privileged -v /tmp:/tmp --network host -it -w $PWD -v $HOME:$HOME \
--user $UID:$GROUPS -v /etc/group:/etc/group  -v /etc/passwd:/etc/passwd \
-v /etc/fonts/:/etc/fonts/ -v /media:/media c3genomics/genpipes:0.8</code></pre>
</div>
<div id="variable-assignment" class="section level5 hasAnchor">
<h5>Variable Assignment<a href="module-3.html#variable-assignment" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<pre><code>export WORK_DIR_M3=$HOME/workspace/HTG/Module3/
export REF=$MUGQIC_INSTALL_HOME/genomes/species/Homo_sapiens.GRCh37/</code></pre>
</div>
<div id="setup" class="section level5 hasAnchor">
<h5>Setup<a href="module-3.html#setup" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<pre><code>mkdir -p $WORK_DIR_M3
cd $WORK_DIR_M3
ln -s $HOME/CourseData/HTG_data/Module3/* .</code></pre>
</div>
<div id="modules" class="section level5 hasAnchor">
<h5>Modules<a href="module-3.html#modules" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>To verify your environment setup:</p>
<pre><code>module avail
module list</code></pre>
</div>
<div id="data-files" class="section level5 hasAnchor">
<h5>Data Files<a href="module-3.html#data-files" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The initial structure of your folders should look like this:</p>
<pre><code>ROOT
|-- raw_reads/               # fastqs from the center (down sampled)
    `-- NA12878/             # Child sample directory
    `-- NA12891/             # Father sample directory
    `-- NA12892/             # Mother sample directory
`-- scripts/                 # command lines scripts
`-- saved_results/           # precomputed final files
`-- adapters.fa              # fasta file containing the adapter used for sequencing`</code></pre>
</div>
<div id="cheat-sheets" class="section level5 hasAnchor">
<h5>Cheat Sheets<a href="module-3.html#cheat-sheets" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<ul>
<li><a href="">Unix command line cheat sheet</a></li>
<li><a href="https://github.com/mbourgey/CBW_HTseq_module3/blob/master/scripts/commands.sh">Commands file of this module</a></li>
</ul>
</div>
</div>
<div id="first-data-glance" class="section level4 hasAnchor">
<h4>First Data Glance<a href="module-3.html#first-data-glance" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>So you’ve just recieved an email saying that your data is ready for download from the sequencing center of your choice.</p>
<strong>1. What should you do?</strong>
<details>
<summary>
Solution (click here)
</summary>
<p>The first thing to do is to download it.</p>
<p>The second thing is making sure it is of good quality.</p>
</details>
<div id="fastq-files" class="section level5 hasAnchor">
<h5>FASTQ Files<a href="module-3.html#fastq-files" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Let’s first explore the FASTQ file.</p>
<p>Try these commands.</p>
<pre><code>less -S raw_reads/NA12878/NA12878_CBW_chr1_R1.fastq.gz</code></pre>
<p>These are FASTQ files.</p>
<strong>1. Could you describe the FASTQ format?</strong>
<details>
<summary>
Solution (click here)
</summary>
<p>There is four lines for each read:</p>
<pre><code>- Header 1
- DNA sequence
- Header 2
- Quality values</code></pre>
</details>
<pre><code>zcat raw_reads/NA12878/NA12878_CBW_chr1_R1.fastq.gz | head -n4
zcat raw_reads/NA12878/NA12878_CBW_chr1_R2.fastq.gz | head -n4</code></pre>
<strong>2. What was special about the output and why was it like like?</strong>
<details>
<summary>
Solution (click here)
</summary>
<p>It’s the same header with a /1 or /2 towards the end. Meaning these are paired data.</p>
</details>
<p>You could also count the reads.</p>
<pre><code>zgrep -c &quot;^@SN1114&quot; raw_reads/NA12878/NA12878_CBW_chr1_R1.fastq.gz</code></pre>
<p>We found 56512 reads.</p>
<p><strong>3. Why shouldn’t you just do?</strong></p>
<pre><code>zgrep -c &quot;^@&quot; raw_reads/NA12878/NA12878_CBW_chr1_R1.fastq.gz</code></pre>
<details>
<summary>
Solution (click here)
</summary>
<p>Because the ASCII quality character has @ as a valid value. If the quality line starts with this character you’ll count it as a read.</p>
<p>By this method 82325 counts are found!</p>
</details>
</div>
<div id="quality" class="section level5 hasAnchor">
<h5>Quality<a href="module-3.html#quality" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>We can’t look at all the reads. Especially when working with whole genome 30x data. You could easilly have Billions of reads.</p>
<p>Tools like <code>FastQC</code> and <code>BVATools readsqc</code> can be used to plot many metrics from these data sets.</p>
<p>Let’s look at the data:</p>
<pre><code>mkdir -p originalQC/NA12878/
java -Xmx1G -jar ${BVATOOLS_JAR} readsqc \
  --read1 raw_reads/NA12878/NA12878_CBW_chr1_R1.fastq.gz \
  --read2 raw_reads/NA12878/NA12878_CBW_chr1_R2.fastq.gz \
  --threads 2 --regionName ACTL8 --output originalQC/NA12878/</code></pre>
<p>Open the images</p>
<strong>1. What stands out in the graphs?</strong>
<details>
<summary>
Solution (click here)
</summary>
<p>Of the raw data we see that:</p>
<ul>
<li><p>Some reads have 3’ ends.</p>
</details></li>
</ul>
<p>All the generated graphics have their uses. This being said, 2 of them are particularly useful to get an overal picture of how good or bad a run went.</p>
<p>These are the Quality box plots</p>
<p><img src="img/quality-box-plot.png" width="1000" alt="Quality box plot."></p>
<p>and the nucleotide content graphs.</p>
<p><img src="img/nucleotide-content.png" width="1000" alt="Nucleotide content."></p>
<p>The Box plot shows the quality distribution of your data. The Graph goes &gt; 100 because both ends are appended one after the other.</p>
<p>The quality of a base is computated using the Phread quality score.</p>
<p><img src="img/phred-formula.png" width="1000" alt="Phred formula."></p>
<p>The formula outputs an integer that is encoded using an <a href="https://en.wikipedia.org/wiki/ASCII">ASCII</a> table.</p>
<p><img src="img/ascii-table.png" width="1000" alt="ASCII table."></p>
<p>The way the lookup is done is by taking the the phred score adding 33 and using this number as a lookup in the table. The Wikipedia entry for the <a href="https://en.wikipedia.org/wiki/FASTQ_format">FASTQ format</a> has a summary of the varying values.</p>
<p>Older illumina runs were using phred+64 instead of phred+33 to encode their fastq files.</p>
</div>
<div id="trimming" class="section level5 hasAnchor">
<h5>Trimming<a href="module-3.html#trimming" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>After this careful analysis of the raw data we see that</p>
<ul>
<li>Some reads have bad 3’ ends.</li>
<li>No read has adapter sequences in it.</li>
</ul>
<p>Although nowadays this doesn’t happen often, it does still happen. In some cases, miRNA, it is expected to have adapters. Since they are not part of the genome of interest they should be removed if enough reads have them.</p>
<p>To be able to remove adapters and low qualtity bases, we will use Trimmomatic.</p>
<p>The adapter file is already in your reference folder.</p>
<p>We can look at the adapters</p>
<pre><code>cat adapters.fa</code></pre>
<strong>1. Why are there 2 different ones?</strong>
<details>
<summary>
Solution (click here)
</summary>
<p>Because both ends of the fragment don’t have the same adapter.</p>
</details>
<p>Let’s try removing them and see what happens.</p>
<pre><code>mkdir -p reads/NA12878/

java -Xmx2G -cp $TRIMMOMATIC_JAR org.usadellab.trimmomatic.TrimmomaticPE -threads 2 -phred33 \
  raw_reads/NA12878/NA12878_CBW_chr1_R1.fastq.gz \
  raw_reads/NA12878/NA12878_CBW_chr1_R2.fastq.gz \
  reads/NA12878/NA12878_CBW_chr1_R1.t20l32.fastq.gz \
  reads/NA12878/NA12878_CBW_chr1_S1.t20l32.fastq.gz \
  reads/NA12878/NA12878_CBW_chr1_R2.t20l32.fastq.gz \
  reads/NA12878/NA12878_CBW_chr1_S2.t20l32.fastq.gz \
  ILLUMINACLIP:adapters.fa:2:30:15 TRAILING:20 MINLEN:32 \
  2&gt; reads/NA12878/NA12878.trim.out

cat reads/NA12878/NA12878.trim.out</code></pre>
<strong>2. What does Trimmomatic says it did?</strong>
<details>
<summary>
Solution (click here)
</summary>
<p>Of the 56512 input pairs:</p>
<ul>
<li><p>99.92% were kept
- 0.06% had only a valid read1
- 0.02% had only a valid read2
- None were fully discarded</p>
</details></li>
</ul>
<p>Let’s look at the graphs now</p>
<pre><code>mkdir -p postTrimQC/
java -Xmx1G -jar ${BVATOOLS_JAR} readsqc \
  --read1 reads/NA12878/NA12878_CBW_chr1_R1.t20l32.fastq.gz \
  --read2 reads/NA12878/NA12878_CBW_chr1_R2.t20l32.fastq.gz \
  --threads 2 --regionName ACTL8 --output postTrimQC/</code></pre>
** 3. How does it look now?**
<details>
<summary>
Solution (click here)
</summary>
<p>It looks better, but there is still some medium-low quality bases that remain.</p>
</details>
** 4. Could we have done a better job?**
<details>
<summary>
Solution (click here)
</summary>
<p>A sliding windows approach would have been more efficient in this case but it comes with the cost of losing more reads (92% both survived)</p>
<p>Raw:</p>
<p><img src="img/raw.png" width="1000" alt="Raw."></p>
<p>Trailing:</p>
<p>&lt;img src=“./img/TR_trim_res.png” width=“1000” alt=“Trimming</p>
<p>Sliding windows:</p>
<p><img src="img/SW_trim_res.png" width="1000" alt="Sliding window."></p>
</details>
</div>
<div id="alignment" class="section level5 hasAnchor">
<h5>Alignment<a href="module-3.html#alignment" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The raw reads are now cleaned up of artefacts we can align the read to the reference.</p>
<p>In case you have multiple readsets or library you should align them separately!</p>
<p><strong>1. Why should this be done separately?</strong> solution</p>
<pre><code>mkdir -p alignment/NA12878/

bwa mem -M -t 2 \
  -R &#39;@RG\tID:NA12878\tSM:NA12878\tLB:NA12878\tPU:runNA12878_1\tCN:Broad Institute\tPL:ILLUMINA&#39; \
  $REF/genome/bwa_index/Homo_sapiens.GRCh37.fa \
  reads/NA12878/NA12878_CBW_chr1_R1.t20l32.fastq.gz \
  reads/NA12878/NA12878_CBW_chr1_R2.t20l32.fastq.gz \
  | java -Xmx2G -jar ${GATK_JAR} SortSam \
  -I /dev/stdin \
  -O alignment/NA12878/NA12878.sorted.bam \
  -SO coordinate \
  --CREATE_INDEX true --MAX_RECORDS_IN_RAM 500000</code></pre>
<p><strong>2. Why is it important to set Read Group information?</strong> solution</p>
<p>The details of the fields can be found in the SAM/BAM specifications <a href="https://samtools.github.io/hts-specs/SAMv1.pdf">Here</a> For most cases, only the sample name, platform unit and library one are important.</p>
<p><strong>3. Why did we pipe the output of one to the other? Could we have done it differently?</strong> solution</p>
</div>
<div id="lane-merging-optional" class="section level5 hasAnchor">
<h5>Lane Merging (Optional)<a href="module-3.html#lane-merging-optional" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>In case we generate multiple lane of sequencing or mutliple library. It is not practical to keep the data splited and all the reads should be merge into one massive file.</p>
<p>Since we identified the reads in the BAM with read groups, even after the merging, we can still identify the origin of each read.</p>
</div>
<div id="sambam" class="section level5 hasAnchor">
<h5>SAM/BAM<a href="module-3.html#sambam" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Let’s spend some time to explore bam files.</p>
<p>Try</p>
<pre><code>samtools view alignment/NA12878/NA12878.sorted.bam | head -n4</code></pre>
<p>Here you have examples of alignment results. A full description of the flags can be found in the <a href="https://samtools.github.io/hts-specs/SAMv1.pdf">SAM specification</a>.</p>
<p>Try using <a href="https://broadinstitute.github.io/picard/explain-flags.html">picards explain flag site</a> to understand what is going on with your reads.</p>
<p>The flag is the 2nd column.</p>
<p><strong>1. What do the flags of the first 4 reads mean?</strong> solution</p>
<p>Let’s take the 3nd one and find it’s pair.</p>
<p>Try</p>
<pre><code>samtools view alignment/NA12878/NA12878.sorted.bam | grep &quot;1313:19317:61840&quot;</code></pre>
<p><strong>2. Why did searching one name find both reads?</strong> solution</p>
<p>You can use samtools to filter reads as well.</p>
<pre><code># Say you want to count the *un-aligned* reads, you can use
samtools view -c -f4 alignment/NA12878/NA12878.sorted.bam

# Or you want to count the *aligned* reads you, can use
samtools view -c -F4 alignment/NA12878/NA12878.sorted.bam</code></pre>
<p><strong>3. How many reads mapped and unmapped were there?</strong> solution</p>
<p>Another useful bit of information in the SAM is the CIGAR string. It’s the 6th column in the file. This column explains how the alignment was achieved.</p>
<ul>
<li>M == base aligns but doesn’t have to be a match. A SNP will have an M even if it disagrees with the reference.</li>
<li>I == Insertion</li>
<li>D == Deletion</li>
<li>S == soft-clips. These are handy to find un removed adapters, viral insertions, etc.</li>
</ul>
<p>An in depth explanation of the CIGAR can be found <a href="https://genome.sph.umich.edu/wiki/SAM">here</a> The exact details of the cigar string can be found in the SAM spec as well. Another good site</p>
</div>
<div id="cleaning-up-alignments" class="section level5 hasAnchor">
<h5>Cleaning up Alignments<a href="module-3.html#cleaning-up-alignments" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>We started by cleaning up the raw reads. Now we need to fix and clean some alignments.</p>
<div id="indel-realignment" class="section level6 hasAnchor">
<h6>Indel realignment<a href="module-3.html#indel-realignment" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>The first step for this is to realign around indels and snp dense regions. The Genome Analysis toolkit has a tool for this called IndelRealigner.</p>
<p>It basically runs in 2 steps</p>
<p>1 - Find the targets
2 - Realign them.</p>
<pre><code>#switch to old GATK 3.8
module unload  mugqic/GenomeAnalysisTK/4.1.0.0
module load mugqic/GenomeAnalysisTK/3.8

java -Xmx2G  -jar ${GATK_JAR} \
  -T RealignerTargetCreator \
  -R $REF/genome/Homo_sapiens.GRCh37.fa \
  -o alignment/NA12878/realign.intervals \
  -I alignment/NA12878/NA12878.sorted.bam \
  -L 1

java -Xmx2G -jar ${GATK_JAR} \
  -T IndelRealigner \
  -R $REF/genome/Homo_sapiens.GRCh37.fa \
  -targetIntervals alignment/NA12878/realign.intervals \
  -o alignment/NA12878/NA12878.realigned.sorted.bam \
  -I alignment/NA12878/NA12878.sorted.bam

#return to GATK 4
module unload mugqic/GenomeAnalysisTK/3.8
module load  mugqic/GenomeAnalysisTK/4.1.0.0</code></pre>
<p><strong>1. How many regions did it think needed cleaning?</strong> solution</p>
</div>
<div id="mark-duplicates" class="section level6 hasAnchor">
<h6>Mark Duplicates<a href="module-3.html#mark-duplicates" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>As the step says, this is to mark duplicate reads.</p>
<p><strong>2. What are duplicate reads?</strong> solution</p>
<p><strong>3. What are they caused by?</strong> solution</p>
<p><strong>4. What are the ways to detect them?</strong> solution</p>
<p>Here we will use the GATK approach:</p>
<pre><code>java -Xmx2G -jar ${GATK_JAR} MarkDuplicates \
  --REMOVE_DUPLICATES false --CREATE_INDEX true \
  -I alignment/NA12878/NA12878.realigned.sorted.bam \
  -O alignment/NA12878/NA12878.sorted.dup.bam \
  --METRICS_FILE=alignment/NA12878/NA12878.sorted.dup.metrics</code></pre>
<p>We can look in the metrics output to see what happened.</p>
<pre><code>less alignment/NA12878/NA12878.sorted.dup.metrics</code></pre>
<p><strong>5. How many duplicates were there?</strong> solution</p>
<p>This is very low, we expect in general &lt;2%.</p>
<p>Note it computed the metrics for each library.</p>
<p><strong>6. Why is this important to do it by library and not to combine everything?</strong> solution</p>
</div>
<div id="recalibration" class="section level6 hasAnchor">
<h6>Recalibration<a href="module-3.html#recalibration" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>This is the last BAM cleaning up step.</p>
<p>The goal for this step is to try to recalibrate base quality scores. The vendors tend to inflate the values of the bases in the reads. Also, this step tries to lower the scores of some biased motifs for some technologies.</p>
<p>It runs in 2 steps,</p>
<p>1 - Build covariates based on context and known snp sites
2 - Correct the reads based on these metrics</p>
<pre><code>java -Xmx2G -jar ${GATK_JAR} BaseRecalibrator \
  -R ${REF}/genome/Homo_sapiens.GRCh37.fa \
  --known-sites  ${REF}/annotations/Homo_sapiens.GRCh37.dbSNP150.vcf.gz \
  -L 1:17704860-18004860 \
  -O alignment/NA12878/NA12878.sorted.dup.recalibration_report.grp \
  -I alignment/NA12878/NA12878.sorted.dup.bam

java -Xmx2G -jar ${GATK_JAR} ApplyBQSR \
  -R ${REF}/genome/Homo_sapiens.GRCh37.fa \
  -bqsr alignment/NA12878/NA12878.sorted.dup.recalibration_report.grp \
  -O alignment/NA12878/NA12878.sorted.dup.recal.bam \
  -I alignment/NA12878/NA12878.sorted.dup.bam</code></pre>
</div>
</div>
<div id="extract-metrics" class="section level5 hasAnchor">
<h5>Extract Metrics<a href="module-3.html#extract-metrics" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Once your whole bam is generated, it’s always a good thing to check the data again to see if everything makes sense.</p>
<div id="compute-coverage" class="section level6 hasAnchor">
<h6>Compute coverage<a href="module-3.html#compute-coverage" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>If you have data from a capture kit, you should see how well your targets worked.</p>
<p>Both GATK and BVATools have depth of coverage tools. We wrote our own in BVAtools because</p>
<ul>
<li>GATK was deprecating theirs
-GATK’s is very slow</li>
<li>We were missing some output that we wanted from the GATK’s one (GC per interval, valid pairs, etc)</li>
</ul>
<p>Here we’ll use the GATK one</p>
<pre><code>#switch to old GATK 3.8
module unload  mugqic/GenomeAnalysisTK/4.1.0.0
module load mugqic/GenomeAnalysisTK/3.8

java  -Xmx2G -jar ${GATK_JAR} \
  -T DepthOfCoverage \
  --omitDepthOutputAtEachBase \
  --summaryCoverageThreshold 10 \
  --summaryCoverageThreshold 25 \
  --summaryCoverageThreshold 50 \
  --summaryCoverageThreshold 100 \
  --start 1 --stop 500 --nBins 499 -dt NONE \
  -R ${REF}/genome/Homo_sapiens.GRCh37.fa \
  -o alignment/NA12878/NA12878.sorted.dup.recal.coverage \
  -I alignment/NA12878/NA12878.sorted.dup.recal.bam \
  -L 1:17700000-18100000

#return to GATK 4
module unload mugqic/GenomeAnalysisTK/3.8
module load  mugqic/GenomeAnalysisTK/4.1.0.0

#### Look at the coverage
less -S alignment/NA12878/NA12878.sorted.dup.recal.coverage.sample_interval_summary</code></pre>
<p>Coverage is the expected ~30x.</p>
<p>summaryCoverageThreshold is a usefull function to see if your coverage is uniform. Another way is to compare the mean to the median. If both are almost equal, your coverage is pretty flat. If both are quite different, that means something is wrong in your coverage.</p>
</div>
<div id="insert-size" class="section level6 hasAnchor">
<h6>Insert Size<a href="module-3.html#insert-size" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<pre><code>java -Xmx2G -jar ${GATK_JAR} CollectInsertSizeMetrics \
  -R ${REF}/genome/Homo_sapiens.GRCh37.fa \
  -I alignment/NA12878/NA12878.sorted.dup.recal.bam \
  -O alignment/NA12878/NA12878.sorted.dup.recal.metric.insertSize.tsv \
  -H alignment/NA12878/NA12878.sorted.dup.recal.metric.insertSize.histo.pdf \
  --METRIC_ACCUMULATION_LEVEL LIBRARY

#look at the output
less -S alignment/NA12878/NA12878.sorted.dup.recal.metric.insertSize.tsv</code></pre>
<p><strong>1. What is the insert size and the corresponding standard deviation?</strong> solution</p>
<p><strong>2. Is the insert-size important?</strong> solution</p>
</div>
<div id="alignment-metrics" class="section level6 hasAnchor">
<h6>Alignment metrics<a href="module-3.html#alignment-metrics" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>For the alignment metrics, we used to use <code>samtools flagstat</code> but with bwa mem since some reads get broken into pieces, the numbers are a bit confusing. You can try it if you want.</p>
<p>We prefer the GATK way of computing metrics</p>
<pre><code>java -Xmx2G -jar ${GATK_JAR} CollectAlignmentSummaryMetrics \
  -R ${REF}/genome/Homo_sapiens.GRCh37.fa \
  -I alignment/NA12878/NA12878.sorted.dup.recal.bam \
  -O alignment/NA12878/NA12878.sorted.dup.recal.metric.alignment.tsv \
  --METRIC_ACCUMULATION_LEVEL LIBRARY

#### explore the results

less -S alignment/NA12878/NA12878.sorted.dup.recal.metric.alignment.tsv</code></pre>
<p><strong>3. What is the percent of aligned reads?</strong> solution</p>
</div>
</div>
<div id="investigating-the-trio-optional" class="section level5 hasAnchor">
<h5>Investigating the Trio (Optional)<a href="module-3.html#investigating-the-trio-optional" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>At this point we have aligned and called variants in one individual. However, we actually have FASTQ and BAM files for three family members (mother and father)!</p>
<p>As additional practice, perform the same steps for the other two individuals (her parents): NA12891 and NA12892.</p>
<p>Quit working node Environment</p>
<pre><code>exit</code></pre>
</div>
<div id="summary" class="section level5 hasAnchor">
<h5>Summary<a href="module-3.html#summary" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>In this lab, we aligned reads from the sample NA12878 to the reference genome <code>GRCh37</code>:</p>
<ul>
<li>We became familiar with FASTQ and SAM/BAM formats.</li>
<li>We checked read QC with BVAtools.</li>
<li>We trimmed unreliable bases from the read ends using Trimmomatic.</li>
<li>We aligned the reads to the reference using BWA.</li>
<li>We sorted the alignments by chromosome position using GATK.</li>
<li>We realigned short indels using GATK.</li>
<li>We fixed mate issues using GATK.</li>
<li>We recalibrate the Base Quality using GATK.</li>
<li>We generate alignment metrics using GATK.</li>
</ul>
<div class="callout-green">
<span class="callout-icon"><i class="fas fa-party-horn" aria-hidden="true"></i></span>
<div class="callout-content">
<div class="callout-title-static center" style="margin-bottom: 0.5em;">
<p>Lab Complete!</p>
</div>
<p>You’re done Module 3! We hope that you enjoyed the lab and that you continue to enjoy Genome Alignment.</p>
</div>
</div>

</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="module-2-data-visualization-with-igv.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="module-4-single-nucleotide-variant-calling.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/cbw-dev/HTG-2021/blob/main/030-module-3.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": ["_main.pdf", "_main.epub"],
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

</body>

</html>
